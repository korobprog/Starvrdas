# Архитектура стриминговой платформы с системой подписок

## Общий обзор

Стриминговая платформа представляет собой монолитное приложение с модульной структурой, разработанное с учетом возможного перехода к микросервисной архитектуре в будущем. Система состоит из трех основных клиентских компонентов и серверной части.

```mermaid
graph TD
    subgraph "Клиентские приложения"
        A[Веб-клиент на React]
        B[Административная панель на React]
        C[PWA для стримеров]
    end

    subgraph "Серверная часть"
        D[Монолитный бэкенд на NestJS]
        E[Ant Media Server]
        F[(PostgreSQL + Prisma)]
        G[(Redis)]
    end

    subgraph "Внешние сервисы"
        H[Telegram API]
        I[Криптоплатежные шлюзы]
        J[YouTube API]
        K[Rutube API]
    end

    A --> D
    B --> D
    C --> D
    C --> E
    D --> E
    D --> F
    D --> G
    D --> H
    D --> I
    E --> J
    E --> K
```

## Технологический стек

### Фронтенд

- **Веб-клиент**: React с TypeScript, Redux для управления состоянием
- **Административная панель**: React с TypeScript, Redux, с использованием тех же компонентов, что и веб-клиент
- **Мобильное приложение**: Progressive Web Application (PWA) на основе React с TypeScript для кроссплатформенного доступа

### Бэкенд

- **Основной сервер**: NestJS (Node.js с TypeScript)
- **Медиа-сервер**: Ant Media Server
- **Контейнеризация**: Docker и Docker Compose

### База данных и кэширование

- **Основная БД**: PostgreSQL с Prisma ORM
- **Кэширование**: Redis для сессий, кэширования и очередей сообщений

## Модульная структура бэкенда

Монолитный бэкенд на NestJS будет разделен на модули, каждый из которых отвечает за определенную функциональность. Это позволит в будущем легко выделить отдельные модули в микросервисы.

```mermaid
graph TD
    subgraph "NestJS Монолит"
        A[Основной модуль]
        B[Модуль аутентификации]
        C[Модуль пользователей]
        D[Модуль подписок]
        E[Модуль платежей]
        F[Модуль стриминга]
        G[Модуль уведомлений]
        H[Модуль календаря]
        I[Модуль аналитики]
    end

    A --> B
    A --> C
    A --> D
    A --> E
    A --> F
    A --> G
    A --> H
    A --> I
```

### Модуль аутентификации

- Интеграция с Telegram API для авторизации
- Управление JWT-токенами
- Проверка прав доступа для администраторов

### Модуль пользователей

- Управление профилями пользователей
- Разделение на роли (зрители, стримеры, администраторы)
- Управление администраторами (@art_om108, @maximkorobkov и др.)

### Модуль подписок

- Гибкая система настройки подписок
- Управление подписками пользователей

### Модуль платежей

- Интеграция с криптоплатежными шлюзами (BTC, ETH, USDT)
- Подготовка к интеграции с фиатными платежами

### Модуль стриминга

- Интеграция с Ant Media Server через REST API
- Управление стримами (создание, остановка, мониторинг)
- Интеграция с YouTube и Rutube API

### Модуль уведомлений

- Отправка уведомлений о начале трансляций
- Push-уведомления для мобильных устройств
- Интеграция с Telegram для отправки сообщений

### Модуль календаря

- Управление расписанием мероприятий
- Назначение стримеров на мероприятия
- Публикация календаря для пользователей

### Модуль аналитики

- Сбор данных о просмотрах, подписках, платежах
- Генерация отчетов для администраторов
- Фильтрация данных по различным параметрам

## Схема базы данных

```mermaid
erDiagram
    USERS {
        id UUID PK
        telegram_id String UK
        username String
        role UserRole
        wallet_balance Decimal
        wallet_currency String
        profile_image String
        created_at DateTime
        updated_at DateTime
    }

    ADMINS {
        id UUID PK
        user_id UUID FK
        permissions JSON
        created_at DateTime
        updated_at DateTime
    }

    SUBSCRIPTION_PLANS {
        id UUID PK
        name String
        description String
        price Decimal
        currency String
        duration Integer
        features JSON
        created_at DateTime
        updated_at DateTime
    }

    SUBSCRIPTIONS {
        id UUID PK
        user_id UUID FK
        plan_id UUID FK
        event_id UUID FK
        start_date DateTime
        end_date DateTime
        status SubscriptionStatus
        created_at DateTime
        updated_at DateTime
    }

    PAYMENTS {
        id UUID PK
        user_id UUID FK
        subscription_id UUID FK
        amount Decimal
        currency String
        payment_method String
        status PaymentStatus
        transaction_id String
        created_at DateTime
        updated_at DateTime
    }

    WALLET_TRANSACTIONS {
        id UUID PK
        user_id UUID FK
        amount Decimal
        currency String
        transaction_type TransactionType
        reference_id UUID
        reference_type String
        status TransactionStatus
        created_at DateTime
    }

    EVENTS {
        id UUID PK
        title String
        description String
        start_time DateTime
        end_time DateTime
        streamer_id UUID FK
        price Decimal
        currency String
        status EventStatus
        created_at DateTime
        updated_at DateTime
    }

    STREAMS {
        id UUID PK
        event_id UUID FK
        streamer_id UUID FK
        title String
        description String
        stream_key String
        status StreamStatus
        start_time DateTime
        end_time DateTime
        youtube_url String
        rutube_url String
        share_url String
        created_at DateTime
        updated_at DateTime
    }

    VIEWS {
        id UUID PK
        stream_id UUID FK
        user_id UUID FK
        start_time DateTime
        end_time DateTime
        duration Integer
        device_info JSON
        created_at DateTime
    }

    SHARES {
        id UUID PK
        user_id UUID FK
        stream_id UUID FK
        platform String
        created_at DateTime
    }

    USERS ||--o{ SUBSCRIPTIONS : "имеет"
    USERS ||--o{ PAYMENTS : "совершает"
    USERS ||--o{ STREAMS : "создает"
    USERS ||--o{ VIEWS : "просматривает"
    USERS ||--o{ ADMINS : "может быть"
    USERS ||--o{ WALLET_TRANSACTIONS : "имеет"
    USERS ||--o{ SHARES : "делает"
    SUBSCRIPTION_PLANS ||--o{ SUBSCRIPTIONS : "используется в"
    SUBSCRIPTIONS ||--o{ PAYMENTS : "оплачивается через"
    EVENTS ||--o{ STREAMS : "имеет"
    EVENTS ||--o{ SUBSCRIPTIONS : "имеет"
    STREAMS ||--o{ VIEWS : "имеет"
    STREAMS ||--o{ SHARES : "имеет"
```

## API-интерфейсы

### REST API

#### Аутентификация

- `POST /api/auth/telegram` - Авторизация через Telegram
- `POST /api/auth/refresh` - Обновление токена
- `GET /api/auth/me` - Получение информации о текущем пользователе

#### Пользователи

- `GET /api/users` - Получение списка пользователей (для админов)
- `GET /api/users/:id` - Получение информации о пользователе
- `GET /api/users/me` - Получение информации о текущем пользователе
- `GET /api/users/me/profile` - Получение профиля текущего пользователя
- `PATCH /api/users/:id` - Обновление информации о пользователе
- `POST /api/users/admins` - Создание нового администратора (для админов)

#### Кошелек

- `GET /api/wallet/balance` - Получение баланса кошелька
- `POST /api/wallet/deposit` - Пополнение кошелька
- `GET /api/wallet/transactions` - Получение истории транзакций

#### Подписки

- `GET /api/subscription-plans` - Получение списка планов подписок
- `POST /api/subscription-plans` - Создание нового плана подписки (для админов)
- `GET /api/subscriptions` - Получение списка подписок пользователя
- `GET /api/subscriptions/active` - Получение списка активных подписок пользователя
- `POST /api/subscriptions` - Создание новой подписки
- `POST /api/events/:id/subscribe` - Подписка на мероприятие

#### Платежи

- `POST /api/payments` - Создание нового платежа
- `GET /api/payments` - Получение списка платежей пользователя
- `GET /api/payments/:id/status` - Проверка статуса платежа

#### Календарь

- `GET /api/events` - Получение списка мероприятий
- `GET /api/events/upcoming` - Получение списка предстоящих мероприятий
- `POST /api/events` - Создание нового мероприятия (для админов)
- `GET /api/events/:id` - Получение информации о мероприятии
- `PATCH /api/events/:id` - Обновление информации о мероприятии (для админов)

#### Стриминг

- `POST /api/streams` - Создание нового стрима
- `GET /api/streams` - Получение списка стримов
- `GET /api/streams/:id` - Получение информации о стриме
- `PATCH /api/streams/:id/status` - Обновление статуса стрима
- `GET /api/streams/live` - Получение списка активных стримов
- `POST /api/streams/:id/share` - Поделиться стримом

#### Аналитика

- `GET /api/analytics/users` - Аналитика по пользователям (для админов)
- `GET /api/analytics/subscriptions` - Аналитика по подпискам (для админов)
- `GET /api/analytics/payments` - Аналитика по платежам (для админов)
- `GET /api/analytics/streams` - Аналитика по стримам (для админов)
- `GET /api/analytics/shares` - Аналитика по поделившимся (для админов)

### WebSocket API

- `ws://api/notifications` - Уведомления в реальном времени
- `ws://api/streams/:id/chat` - Чат во время стримов
- `ws://api/streams/status` - Статусы стримов в реальном времени

## Архитектура стриминга

```mermaid
graph TD
    A[PWA для стримеров] -->|WebRTC| B[Ant Media Server]
    B -->|Транскодирование| C[HLS/DASH сегменты]
    B -->|RTMP| D[YouTube]
    B -->|RTMP| E[Rutube]
    C --> F[CDN]
    F --> G[Веб-клиент/PWA]

    subgraph "Интеграция с NestJS"
        H[Модуль стриминга]
        I[REST API Ant Media Server]
    end

    H --> I
    I --> B
```

### Компоненты стриминга

1. **Входящий поток**:

   - PWA для стримеров отправляет видеопоток через WebRTC на Ant Media Server
   - Поддержка различных разрешений и битрейтов в зависимости от устройства и соединения
   - Использование MediaStream API для доступа к камере и микрофону

2. **Обработка потока**:

   - Ant Media Server принимает входящие потоки
   - Транскодирует видео в различные качества для адаптивного стриминга
   - Создает HLS/DASH сегменты для адаптивного стриминга
   - Перенаправляет потоки на YouTube и Rutube через их API

3. **Доставка контента**:
   - CDN для распределения нагрузки и уменьшения задержки
   - HLS/DASH протоколы для адаптивного стриминга
   - WebRTC для стримов с низкой задержкой

## Компоненты пользовательского интерфейса

### Веб-клиент

```mermaid
graph TD
    A[Главная страница] --> B[Страница авторизации через Telegram]
    B --> C[Личный кабинет]
    C --> D[Профиль пользователя]
    C --> E[Кошелек]
    C --> F[Активные подписки]
    C --> G[История просмотров]
    A --> H[Каталог мероприятий]
    H --> I[Страница мероприятия]
    I --> J[Оплата подписки]
    A --> K[Активные стримы]
    K --> L[Страница просмотра стрима]
    L --> M[Поделиться в соцсети/мессенджеры]
```

#### Профиль пользователя

- Информация о пользователе (имя, фото профиля)
- Баланс кошелька
- Список активных подписок
- История просмотров
- Настройки профиля

#### Кошелек

- Текущий баланс
- История транзакций
- Пополнение кошелька
- Автоматическое списание средств при подписке на мероприятие

#### Каталог мероприятий

- Список предстоящих мероприятий
- Фильтрация и поиск мероприятий
- Подписка на мероприятие с оплатой из кошелька

#### Страница просмотра стрима

- Видеоплеер с адаптивным качеством
- Чат
- Кнопки для шеринга в социальные сети и мессенджеры

### Административная панель

```mermaid
graph TD
    A[Главная страница админа] --> B[Управление пользователями]
    A --> C[Управление подписками]
    A --> D[Управление мероприятиями]
    A --> E[Управление стримами]
    A --> F[Аналитика]
    F --> G[Аналитика пользователей]
    F --> H[Аналитика подписок]
    F --> I[Аналитика платежей]
    F --> J[Аналитика стримов]
    F --> K[Аналитика шеринга]
```

## Развертывание и масштабирование

### Начальное развертывание

- Docker Compose для локальной разработки и тестирования
- Контейнеризация всех компонентов системы (NestJS, Ant Media Server, PostgreSQL, Redis)
- Автоматизация развертывания с помощью CI/CD (GitHub Actions или GitLab CI)

### Масштабирование в будущем

- Выделение модулей в отдельные микросервисы
- Использование API Gateway для маршрутизации запросов
- Горизонтальное масштабирование микросервисов при увеличении нагрузки
- Репликация базы данных для повышения производительности
- Использование Kubernetes для оркестрации контейнеров при росте системы

## План реализации

1. **Фаза 1: Базовая инфраструктура**

   - Настройка проекта NestJS с модульной структурой
   - Настройка Docker и Docker Compose
   - Настройка базы данных PostgreSQL с Prisma
   - Настройка Redis для кэширования
   - Настройка базовой PWA с манифестом и Service Worker

2. **Фаза 2: Аутентификация и пользователи**

   - Реализация авторизации через Telegram
   - Реализация управления пользователями и ролями
   - Реализация административного доступа
   - Реализация профиля пользователя

3. **Фаза 3: Кошелек, подписки и платежи**

   - Реализация системы кошелька пользователя
   - Реализация системы подписок
   - Интеграция с криптоплатежными шлюзами
   - Реализация автоматического списания средств при подписке

4. **Фаза 4: Стриминг и шеринг**

   - Настройка Ant Media Server
   - Интеграция с NestJS
   - Реализация WebRTC стриминга через PWA
   - Реализация адаптивного стриминга
   - Интеграция с YouTube и Rutube
   - Реализация функционала шеринга в соцсети и мессенджеры
   - Оптимизация PWA для мобильных устройств

5. **Фаза 5: Календарь и уведомления**

   - Реализация системы календаря мероприятий
   - Реализация страницы с предстоящими мероприятиями
   - Реализация системы уведомлений
   - Интеграция с Telegram для отправки уведомлений

6. **Фаза 6: Аналитика и отчеты**

   - Реализация сбора данных для аналитики
   - Реализация фильтров и отчетов
   - Реализация административной панели для аналитики

7. **Фаза 7: Тестирование и оптимизация**
   - Нагрузочное тестирование
   - Оптимизация производительности PWA
   - Тестирование на различных устройствах и браузерах
   - Оптимизация для офлайн-режима
   - Исправление ошибок

## Многоязычность клиентского приложения

### Общая архитектура многоязычности

```mermaid
graph TD
   A[Клиентское приложение] --> B[i18n модуль]
   B --> C[Хранилище переводов]
   B --> D[Компоненты с поддержкой локализации]
   B --> E[Сервис определения языка]
   E --> F[Определение по браузеру]
   E --> G[Выбор пользователя]
   E --> H[Геолокация]
   C --> I[Русский язык]
   C --> J[Английский язык]
   K[Бэкенд] --> L[API с поддержкой локализации]
   L --> M[Локализованные данные]
   L --> N[Метаданные контента]
```

### Технический стек для многоязычности

- **Фронтенд**:
- React-i18next для управления переводами в React-приложениях
- Формат JSON для файлов переводов
- Динамическая загрузка языковых пакетов для оптимизации производительности
- Компоненты с поддержкой RTL (для возможного добавления языков с письмом справа налево в будущем)

- **Бэкенд**:
- NestJS i18n модуль для локализации серверных сообщений
- Хранение локализованного контента в базе данных с языковыми метками
- API для получения переводов и локализованного контента

### Структура данных для многоязычности

```mermaid
erDiagram
   LANGUAGES {
       id UUID PK
       code String UK
       name String
       is_default Boolean
       is_active Boolean
       created_at DateTime
       updated_at DateTime
   }

   TRANSLATIONS {
       id UUID PK
       language_id UUID FK
       namespace String
       key String
       value Text
       created_at DateTime
       updated_at DateTime
   }

   LOCALIZED_CONTENT {
       id UUID PK
       entity_id UUID
       entity_type String
       language_id UUID FK
       field_name String
       value Text
       created_at DateTime
       updated_at DateTime
   }

   USER_LANGUAGE_PREFERENCES {
       id UUID PK
       user_id UUID FK
       language_id UUID FK
       created_at DateTime
       updated_at DateTime
   }

   LANGUAGES ||--o{ TRANSLATIONS : "содержит"
   LANGUAGES ||--o{ LOCALIZED_CONTENT : "имеет"
   LANGUAGES ||--o{ USER_LANGUAGE_PREFERENCES : "выбран"
```

### API для многоязычности

- `GET /api/languages` - Получение списка доступных языков
- `GET /api/translations/:lang` - Получение переводов для конкретного языка
- `GET /api/translations/:lang/:namespace` - Получение переводов для конкретного языка и пространства имен
- `PATCH /api/users/me/language` - Обновление языковых предпочтений пользователя

### Компоненты пользовательского интерфейса для многоязычности

- Селектор языка в шапке сайта
- Автоматическое определение языка при первом посещении
- Сохранение выбранного языка в профиле пользователя и локальном хранилище
- Адаптация UI под особенности выбранного языка (длина текста, направление письма)

### Процесс локализации

- Использование ключей для всех текстовых строк в приложении
- Автоматическое извлечение ключей из исходного кода
- Интерфейс администратора для управления переводами
- Возможность экспорта/импорта переводов в формате JSON/CSV

## Подключение платежных шлюзов для различных стран

### Общая архитектура платежной системы

```mermaid
graph TD
   A[Модуль платежей] --> B[Абстрактный интерфейс платежного шлюза]
   B --> C[Фабрика платежных шлюзов]
   C --> D[Определение региона пользователя]
   D --> E[Выбор доступных платежных методов]

   C --> F[Платежные шлюзы России]
   C --> G[Платежные шлюзы СНГ]
   C --> H[Платежные шлюзы Европы]
   C --> I[Платежные шлюзы Индии]

   F --> F1[ЮKassa]
   F --> F2[СБП]
   F --> F3[Криптовалютные шлюзы]

   G --> G1[Kaspi KZ]
   G --> G2[Белкарт]
   G --> G3[Криптовалютные шлюзы]

   H --> H1[Stripe]
   H --> H2[PayPal]
   H --> H3[Криптовалютные шлюзы]

   I --> I1[UPI]
   I --> I2[Paytm]
   I --> I3[RazorPay]
   I --> I4[PhonePe]
   I --> I5[Google Pay India]

   J[Сервис валидации платежей] --> K[Проверка статуса]
   J --> L[Обработка колбэков]
   J --> M[Обработка ошибок]

   N[Сервис конвертации валют] --> O[Актуальные курсы валют]
   N --> P[Расчет комиссий]

   Q[Сервис соответствия регуляторным требованиям] --> R[Россия]
   Q --> S[СНГ]
   Q --> T[Европа]
   Q --> U[Индия]
```

### Расширение модуля платежей

```mermaid
graph TD
   A[Модуль платежей] --> B[Подмодуль региональных платежей]
   B --> C[Сервис определения региона]
   B --> D[Сервис доступных методов оплаты]
   B --> E[Сервис валидации платежей]
   B --> F[Сервис конвертации валют]
   B --> G[Сервис соответствия регуляторным требованиям]

   H[Модуль подписок] --> I[Региональные цены]
   H --> J[Валютные настройки]

   K[Модуль пользователей] --> L[Региональные настройки]
   K --> M[Предпочитаемая валюта]
```

### Расширение схемы базы данных

```mermaid
erDiagram
   PAYMENT_GATEWAYS {
       id UUID PK
       name String
       code String UK
       region String
       countries JSON
       currencies JSON
       config JSON
       is_active Boolean
       created_at DateTime
       updated_at DateTime
   }

   PAYMENT_METHODS {
       id UUID PK
       gateway_id UUID FK
       name String
       code String
       icon String
       min_amount Decimal
       max_amount Decimal
       currencies JSON
       is_active Boolean
       created_at DateTime
       updated_at DateTime
   }

   CURRENCIES {
       id UUID PK
       code String UK
       name String
       symbol String
       is_default Boolean
       is_active Boolean
       created_at DateTime
       updated_at DateTime
   }

   EXCHANGE_RATES {
       id UUID PK
       from_currency String
       to_currency String
       rate Decimal
       updated_at DateTime
   }

   REGIONS {
       id UUID PK
       code String UK
       name String
       countries JSON
       default_currency String
       available_gateways JSON
       created_at DateTime
       updated_at DateTime
   }

   REGULATORY_REQUIREMENTS {
       id UUID PK
       region_id UUID FK
       code String
       name String
       description Text
       implementation_details JSON
       is_mandatory Boolean
       created_at DateTime
       updated_at DateTime
   }

   SUBSCRIPTION_PLANS ||--o{ SUBSCRIPTION_PLAN_PRICES : "имеет"
   SUBSCRIPTION_PLAN_PRICES {
       id UUID PK
       plan_id UUID FK
       currency_id UUID FK
       region_id UUID FK
       price Decimal
       created_at DateTime
       updated_at DateTime
   }

   PAYMENT_GATEWAYS ||--o{ PAYMENT_METHODS : "предоставляет"
   REGIONS ||--o{ SUBSCRIPTION_PLAN_PRICES : "имеет"
   REGIONS ||--o{ REGULATORY_REQUIREMENTS : "требует"
   CURRENCIES ||--o{ SUBSCRIPTION_PLAN_PRICES : "используется в"
   CURRENCIES ||--o{ EXCHANGE_RATES : "конвертируется из"
   CURRENCIES ||--o{ EXCHANGE_RATES : "конвертируется в"
```

### Расширение API для платежей

- `GET /api/payment-methods` - Получение доступных методов оплаты для текущего региона пользователя
- `GET /api/currencies` - Получение списка поддерживаемых валют
- `GET /api/subscription-plans/prices` - Получение цен планов подписок в валюте пользователя
- `POST /api/payments/init` - Инициализация платежа с выбором платежного метода
- `GET /api/regions` - Получение информации о регионах и доступных платежных методах

### Интеграция с платежными шлюзами

#### Россия

- ЮKassa (Юмани) - для карт и электронных кошельков
- Система быстрых платежей (СБП) - для банковских переводов
- Криптовалютные шлюзы - для платежей в BTC, ETH, USDT

#### СНГ

- Kaspi KZ - для Казахстана
- Белкарт - для Беларуси
- Криптовалютные шлюзы - для всех стран СНГ

#### Европа

- Stripe - для карт и банковских переводов
- PayPal - для электронных платежей
- Криптовалютные шлюзы - для всех европейских стран

#### Индия

- UPI (Unified Payments Interface) - популярная система мгновенных платежей
- Paytm - крупнейший цифровой кошелек и платежная система
- RazorPay - платежный шлюз для онлайн-бизнеса
- PhonePe - популярное платежное приложение
- Google Pay India - адаптированная для индийского рынка версия

### Соответствие регуляторным требованиям

#### Индия

- **Требования RBI (Reserve Bank of India)**:
- Двухфакторная аутентификация для всех онлайн-транзакций
- Хранение данных платежных карт только на серверах в Индии
- Соответствие стандарту PCI DSS для обработки платежных данных
- Интеграция с системой UPI для мгновенных платежей

- **Требования KYC (Know Your Customer)**:
- Верификация личности для транзакций выше определенной суммы
- Сбор и хранение необходимых идентификационных данных
- Интеграция с Aadhaar (система уникальной идентификации в Индии)

- **Налоговые требования**:
- Автоматический расчет и удержание GST (Goods and Services Tax)
- Формирование налоговых отчетов для индийских пользователей
- Соответствие требованиям TDS (Tax Deducted at Source)

### Процесс обработки платежей

```mermaid
sequenceDiagram
   participant User as Пользователь
   participant Frontend as Фронтенд
   participant API as API сервер
   participant PaymentService as Сервис платежей
   participant RegService as Сервис регуляторных требований
   participant Gateway as Платежный шлюз
   participant DB as База данных

   User->>Frontend: Выбор подписки
   Frontend->>API: Запрос доступных методов оплаты
   API->>PaymentService: Определение региона пользователя
   PaymentService->>DB: Получение доступных шлюзов для региона
   DB->>PaymentService: Список доступных шлюзов
   PaymentService->>RegService: Проверка регуляторных требований
   RegService->>PaymentService: Применимые требования
   PaymentService->>API: Доступные методы оплаты с учетом требований
   API->>Frontend: Отображение методов оплаты

   User->>Frontend: Выбор метода оплаты
   Frontend->>API: Инициализация платежа
   API->>PaymentService: Создание платежа
   PaymentService->>RegService: Применение регуляторных требований
   RegService->>PaymentService: Модифицированный запрос платежа
   PaymentService->>Gateway: Запрос на создание платежа
   Gateway->>PaymentService: Ссылка на оплату / токен
   PaymentService->>DB: Сохранение информации о платеже
   PaymentService->>API: Данные для оплаты
   API->>Frontend: Перенаправление на оплату

   User->>Gateway: Оплата
   Gateway->>API: Уведомление о статусе платежа (webhook)
   API->>PaymentService: Обработка уведомления
   PaymentService->>RegService: Проверка соответствия требованиям
   RegService->>PaymentService: Результат проверки
   PaymentService->>DB: Обновление статуса платежа
   PaymentService->>DB: Активация подписки

   User->>Frontend: Возврат на сайт
   Frontend->>API: Проверка статуса платежа
   API->>PaymentService: Запрос статуса
   PaymentService->>DB: Получение статуса
   DB->>PaymentService: Статус платежа
   PaymentService->>API: Результат платежа
   API->>Frontend: Отображение результата
```

### Интеграция многоязычности и платежных шлюзов в существующую архитектуру

#### Обновление модульной структуры бэкенда

```mermaid
graph TD
   subgraph "NestJS Монолит"
       A[Основной модуль]
       B[Модуль аутентификации]
       C[Модуль пользователей]
       D[Модуль подписок]
       E[Модуль платежей]
       F[Модуль стриминга]
       G[Модуль уведомлений]
       H[Модуль календаря]
       I[Модуль аналитики]
       J[Модуль локализации]
       K[Модуль региональных настроек]
       L[Модуль регуляторных требований]
   end

   A --> B
   A --> C
   A --> D
   A --> E
   A --> F
   A --> G
   A --> H
   A --> I
   A --> J
   A --> K
   A --> L

   J --> C
   J --> D
   J --> G
   J --> H

   K --> C
   K --> D
   K --> E

   L --> E
   L --> C
```

#### Обновление клиентских приложений

```mermaid
graph TD
   subgraph "Клиентские приложения"
       A[Веб-клиент на React]
       B[Административная панель на React]
       C[PWA для стримеров]

       A1[i18n модуль]
       A2[Модуль региональных платежей]

       B1[i18n модуль]
       B2[Управление переводами]
       B3[Управление региональными настройками]
       B4[Управление регуляторными требованиями]

       C1[i18n модуль]
   end

   A --> A1
   A --> A2

   B --> B1
   B --> B2
   B --> B3
   B --> B4

   C --> C1
```

### План реализации

#### Фаза 1: Подготовка инфраструктуры

- Добавление таблиц для языков и переводов в базу данных
- Добавление таблиц для региональных настроек и платежных шлюзов
- Добавление таблиц для регуляторных требований
- Настройка i18n библиотек на фронтенде и бэкенде
- Создание базовых интерфейсов для платежных шлюзов

#### Фаза 2: Реализация многоязычности

- Реализация модуля локализации на бэкенде
- Интеграция i18next в клиентские приложения
- Создание компонентов для выбора языка
- Подготовка базовых переводов для русского и английского языков
- Адаптация UI для поддержки разных языков

#### Фаза 3: Реализация региональных платежных шлюзов

- Реализация модуля региональных настроек
- Реализация модуля регуляторных требований
- Интеграция с платежными шлюзами для России (ЮKassa, СБП)
- Интеграция с платежными шлюзами для СНГ
- Интеграция с платежными шлюзами для Европы (Stripe, PayPal)
- Интеграция с платежными шлюзами для Индии (UPI, Paytm, RazorPay)
- Реализация сервиса конвертации валют
- Реализация сервиса соответствия регуляторным требованиям

#### Фаза 4: Интеграция и тестирование

- Интеграция многоязычности и платежных шлюзов в существующие модули
- Тестирование локализации на разных языках
- Тестирование платежей через различные шлюзы
- Тестирование соответствия регуляторным требованиям
- Оптимизация производительности

#### Фаза 5: Административные инструменты

- Реализация интерфейса для управления переводами
- Реализация интерфейса для управления региональными настройками
- Реализация интерфейса для управления платежными шлюзами
- Реализация интерфейса для управления регуляторными требованиями
- Реализация аналитики по регионам и валютам

## Дополнительные аспекты многоязычности

### Миграция существующего контента

```mermaid
graph TD
    A[Аудит существующего контента] --> B[Извлечение текстовых строк]
    B --> C[Создание ключей для i18n]
    C --> D[Перевод на поддерживаемые языки]
    D --> E[Валидация переводов]
    E --> F[Интеграция в систему i18n]
    F --> G[Тестирование локализованного контента]
```

- **Аудит контента**:

  - Инвентаризация всех текстовых строк в интерфейсе
  - Определение контекстно-зависимых строк
  - Выявление строк, требующих специальной обработки (даты, числа, валюты)

- **Стратегия извлечения**:

  - Автоматическое извлечение строк из исходного кода
  - Ручное извлечение строк из статического контента
  - Создание уникальных идентификаторов для каждой строки

- **Процесс перевода**:
  - Создание глоссария терминов для обеспечения согласованности
  - Привлечение профессиональных переводчиков для начального перевода
  - Настройка процесса проверки качества переводов

### Автоматизация процесса локализации

- **Инструменты для разработчиков**:

  - Линтеры для проверки использования i18n в коде
  - Автоматическое извлечение строк при сборке проекта
  - Предупреждения о непереведенных строках

- **Интеграция с системами управления переводами**:

  - API для синхронизации с внешними системами перевода
  - Автоматическое обновление переводов при изменении исходных строк
  - Версионирование переводов для отслеживания изменений

- **CI/CD интеграция**:
  - Проверка полноты переводов в процессе сборки
  - Автоматическая генерация отчетов о состоянии локализации
  - Блокирование релизов при критических проблемах с локализацией

### Тестирование локализации

- **Автоматизированное тестирование**:

  - Проверка корректности отображения интерфейса на разных языках
  - Тестирование переполнения UI при использовании длинных переводов
  - Проверка корректности форматирования дат, чисел и валют

- **Ручное тестирование**:

  - Привлечение носителей языка для проверки качества переводов
  - Проверка культурной адаптации контента
  - Тестирование удобства использования на разных языках

- **A/B тестирование**:
  - Оценка эффективности локализации для разных регионов
  - Анализ поведения пользователей на разных языках
  - Оптимизация переводов на основе пользовательского опыта

### Мониторинг качества переводов

- **Система обратной связи**:

  - Возможность для пользователей сообщать о проблемах с переводами
  - Рейтинговая система для оценки качества переводов
  - Сбор предложений по улучшению переводов

- **Аналитика использования языков**:

  - Отслеживание популярности различных языков
  - Анализ конверсии в зависимости от выбранного языка
  - Определение приоритетов для улучшения переводов

- **Процесс обновления переводов**:
  - Регулярный аудит качества переводов
  - Процедура обновления проблемных переводов
  - Система уведомлений о критических проблемах с переводами

## Дополнительные аспекты платежной системы

### Стратегия безопасности платежей

```mermaid
graph TD
    A[Многоуровневая защита платежей] --> B[Шифрование данных]
    A --> C[Аутентификация и авторизация]
    A --> D[Мониторинг и обнаружение мошенничества]
    A --> E[Соответствие стандартам]

    B --> B1[Шифрование в движении]
    B --> B2[Шифрование в покое]
    B --> B3[Токенизация платежных данных]

    C --> C1[Многофакторная аутентификация]
    C --> C2[Биометрическая верификация]
    C --> C3[Проверка адреса доставки]

    D --> D1[Анализ поведенческих паттернов]
    D --> D2[Геолокационная проверка]
    D --> D3[Лимиты транзакций]

    E --> E1[PCI DSS]
    E --> E2[GDPR]
    E --> E3[Локальные регуляторные требования]
```

- **Шифрование данных**:

  - Использование TLS 1.3 для всех платежных коммуникаций
  - Шифрование платежных данных в базе данных
  - Токенизация чувствительной информации
  - Управление ключами шифрования с регулярной ротацией

- **Аутентификация и авторизация**:

  - Реализация 3D Secure 2.0 для карточных платежей
  - Биометрическая верификация для мобильных платежей
  - Многофакторная аутентификация для высокорисковых транзакций
  - Проверка адреса доставки (AVS) для карточных платежей

- **Обнаружение мошенничества**:

  - Система оценки рисков в реальном времени
  - Анализ поведенческих паттернов пользователей
  - Геолокационная проверка для выявления подозрительных транзакций
  - Установка лимитов транзакций и триггеров для ручной проверки

- **Соответствие стандартам**:
  - Сертификация PCI DSS для обработки карточных данных
  - Соответствие GDPR для европейских пользователей
  - Соответствие локальным регуляторным требованиям в каждом регионе
  - Регулярный аудит безопасности и тестирование на проникновение

### Обработка возвратов и споров

```mermaid
sequenceDiagram
    participant User as Пользователь
    participant Support as Служба поддержки
    participant RefundService as Сервис возвратов
    participant PaymentGateway as Платежный шлюз
    participant DB as База данных

    User->>Support: Запрос на возврат
    Support->>RefundService: Создание заявки на возврат
    RefundService->>DB: Проверка статуса платежа
    DB->>RefundService: Информация о платеже

    alt Возврат возможен
        RefundService->>PaymentGateway: Запрос на возврат
        PaymentGateway->>RefundService: Подтверждение возврата
        RefundService->>DB: Обновление статуса платежа
        RefundService->>Support: Уведомление об успешном возврате
        Support->>User: Уведомление о возврате
    else Возврат невозможен
        RefundService->>Support: Причина отказа
        Support->>User: Объяснение причины отказа
    end
```

- **Политика возвратов**:

  - Четкие правила для полных и частичных возвратов
  - Временные ограничения для запросов на возврат
  - Автоматизированная обработка стандартных случаев
  - Ручная обработка сложных случаев

- **Обработка споров**:

  - Система для регистрации и отслеживания споров
  - Автоматический сбор доказательств для разрешения споров
  - Интеграция с платежными шлюзами для обработки чарджбэков
  - Аналитика споров для выявления проблемных областей

- **Коммуникация с пользователями**:
  - Автоматические уведомления о статусе возврата
  - Прозрачная информация о процессе обработки споров
  - Возможность предоставления дополнительной информации
  - Система обратной связи после разрешения спора

### Тестирование платежных интеграций

- **Автоматизированное тестирование**:

  - Модульные тесты для платежных компонентов
  - Интеграционные тесты с песочницами платежных шлюзов
  - Тестирование производительности под нагрузкой
  - Тестирование отказоустойчивости и восстановления после сбоев

- **Сценарии тестирования**:

  - Успешные платежи через различные шлюзы
  - Обработка отказов и ошибок
  - Тестирование возвратов и частичных возвратов
  - Тестирование международных транзакций
  - Проверка конвертации валют

- **Тестовые окружения**:
  - Изолированные среды для каждого платежного шлюза
  - Имитация различных географических регионов
  - Симуляция различных устройств и браузеров
  - Тестовые аккаунты с различными уровнями доступа

### Мониторинг и аудит платежных операций

- **Мониторинг в реальном времени**:

  - Дашборды с ключевыми метриками платежей
  - Оповещения о критических ошибках и аномалиях
  - Отслеживание времени ответа платежных шлюзов
  - Мониторинг коэффициента успешных транзакций

- **Аудит транзакций**:

  - Детальное логирование всех платежных операций
  - Защищенное хранение аудиторских следов
  - Инструменты для анализа и поиска по истории транзакций
  - Регулярные отчеты о платежной активности

- **Аналитика платежей**:
  - Анализ конверсии по различным платежным методам
  - Выявление проблемных платежных шлюзов
  - Анализ распределения платежей по регионам и валютам
  - Прогнозирование платежной активности

### Интеграция с бухгалтерскими системами

- **Автоматизация учета**:

  - Синхронизация платежных данных с бухгалтерскими системами
  - Автоматическое формирование проводок
  - Генерация финансовых отчетов
  - Расчет налогов в соответствии с требованиями разных стран

- **Управление выручкой**:

  - Отслеживание выручки по различным категориям
  - Распределение доходов между партнерами
  - Управление комиссиями платежных шлюзов
  - Прогнозирование денежных потоков

- **Соответствие финансовым требованиям**:
  - Генерация отчетов для налоговых органов
  - Соответствие требованиям финансового учета
  - Подготовка данных для аудита
  - Хранение финансовых документов в соответствии с требованиями законодательства
